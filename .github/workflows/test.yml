name: Test Suite

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]
    workflow_dispatch:
      inputs:
        test_modules:
          description: 'Test modules to run (comma-separated, or "all" for everything)'
          required: false
          type: string
          default: 'tests/'

jobs:
  setup:
    runs-on: ubuntu-latest
    name: Setup and Install Dependencies
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      id: pip-cache
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Cache pip dependencies
      if: steps.pip-cache.outputs.cache-hit != 'true'
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
    
    - name: Verify installation
      run: |
        python --version
        pip --version
        pytest --version
        echo "âœ… All dependencies installed successfully"

  test:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11']
    
    name: Run Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Run tests
      id: run_tests
      env:
        TEST_MODULES: ${{ github.event.inputs.test_modules || 'tests/' }}
      run: |
        # è®¾ç½®æµ‹è¯•è¶…æ—¶æ—¶é—´
        echo "ğŸ§ª Running tests with modules: $TEST_MODULES"
        
        # è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        if [ "$TEST_MODULES" == "tests/" ] || [ "$TEST_MODULES" == "all" ]; then
          echo "Running all tests..."
          pytest tests/ -v \
            --tb=short \
            --cov=app \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-config=pyproject.toml
        else
          echo "Running specific tests: $TEST_MODULES"
          pytest $TEST_MODULES -v \
            --tb=short \
            --cov=app \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-config=pyproject.toml
        
        echo "âœ… Tests completed"
    
    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.11'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittest
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: htmlcov/
        retention-days: 30
    
    - name: Generate test summary
      if: matrix.python-version == '3.11'
      run: |
        # ä»pytestè¾“å‡ºä¸­æå–æµ‹è¯•ç»“æœ
        if [ -f htmlcov/index.html ]; then
          echo "âœ… Coverage report generated successfully"
          echo "ğŸ“Š Coverage report available at: htmlcov/index.html"
          
          # æå–è¦†ç›–ç‡æ•°æ®
          COVERAGE=$(grep -oP 'span class="pc">.*?</span>' htmlcov/index.html | grep -o '[0-9]*[0-9]*' | head -1)
          if [ -z "$COVERAGE" ]; then
            COVERAGE="0.0"
          fi
          
          echo "Test Coverage: $COVERAGE%"
          echo "test_coverage=$COVERAGE%" >> $GITHUB_ENV
        else
          echo "âŒ Coverage report not found"
          echo "test_coverage=0.0%" >> $GITHUB_ENV
    
    - name: Comment PR with test results
      if: github.event_name == 'pull_request' && matrix.python-version == '3.11'
      uses: actions/github-script@v6
      with:
        script: |
          # è·å–è¦†ç›–ç‡æ•°æ®
          coverage=$(grep 'test_coverage=' $GITHUB_ENV | cut -d'=' -f2)
          echo "Coverage: $coverage%"
          
          # æ„å»ºè¯„è®ºå†…å®¹
          comment="## ğŸ§ª æµ‹è¯•ç»“æœ\n\n"
          comment+="- **æµ‹è¯•çŠ¶æ€**ï¼šâœ… é€šè¿‡\n"
          comment+="- **æµ‹è¯•è¦†ç›–ç‡**ï¼š${coverage}%\n\n"
          comment+="### ğŸ“Š æµ‹è¯•ç»Ÿè®¡\n\n"
          comment+="| æŒ‡æ ‡ | æ•°å€¼ |\n"
          comment+="|------|------|\n"
          comment+="| æµ‹è¯•ç”¨ä¾‹æ€»æ•° | ${TEST_COUNT} |\n"
          comment+="| é€šè¿‡æ•° | ${PASSED} |\n"
          comment+="| å¤±è´¥æ•° | ${FAILED} |\n"
          comment+="| è¦†ç›–ç‡ | ${coverage}% |\n"
          comment+="\n"
          comment+="### ğŸ“ è¯¦ç»†æŠ¥å‘Š\n\n"
          comment+="è¦†ç›–ç‡æŠ¥å‘Šï¼š[é“¾æ¥](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n"
          
          # å‘é€è¯„è®º
          gh pr comment ${{ github.event.number }} --body "$comment"
        github-token: ${{ secrets.GITHUB_TOKEN }}
